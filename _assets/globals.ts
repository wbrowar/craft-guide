import {
  FieldHeaderButton,
  GuideListGuide,
  PluginSettings,
  PluginUserOperations,
  ShowGuideSlideoutOptions,
} from './types'

const globalsElement = document.getElementById('guide-admin-globals')

export function addFieldHeaderGuideButton({
  buttonOptions,
  fieldHandle,
}: {
  buttonOptions: FieldHeaderButton
  fieldHandle: string
}) {
  const fields = document.querySelectorAll(
    `:is(#content, .lp-content, .so-content) .field[data-attribute="${fieldHandle}"]:not(:has(guide-slideout-button)) > .heading`
  )
  fields.forEach((field) => {
    // Add spacer to align button to the other side of the `.heading` element.
    if (!field.querySelector('.flex-grow')) {
      const spacerElement = document.createElement('div')
      spacerElement.classList.add('flex-grow')
      field?.append(spacerElement)
    }
    // Add small guide button
    // TODO translate 'Guide'
    field?.append(guideButtonNode(buttonOptions))
  })
}
export function addFieldHeaderGuideButtons() {
  Object.keys(fieldHeaderButtons).forEach((key) => {
    addFieldHeaderGuideButton({ buttonOptions: fieldHeaderButtons[key], fieldHandle: key })
  })
}
export const assetPath: string = globalsElement?.dataset?.assetPath || ''
export const devMode: boolean = globalsElement?.dataset?.devMode ? globalsElement.dataset.devMode === 'true' : false
export const fieldHeaderButtons: Record<string, FieldHeaderButton> = globalsElement?.dataset?.fieldHeaderButtons
  ? JSON.parse(globalsElement?.dataset?.fieldHeaderButtons)
  : []
export function guideButtonNode({ label, slug, small = false }: { label: string; slug: string; small?: boolean }) {
  const guideButton = document.createElement('guide-slideout-button')
  // guideButton.style.marginInlineStart = 'auto'
  guideButton.setAttribute('page-slug', slug)
  guideButton.innerHTML = `<button class="btn${small ? ' small' : ''}" type="button">
    ${guideIconSvg}
    <span>${label}</span>
  </button>`

  return guideButton
}
export const guideIconSvg = `<svg id="Layer_3" data-name="Layer 3" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1024 1024"><path d="M563.88,325.75c1.24.08,2.48.16,3.72.27,3.54.31,6.85-.19,9.72-2.28,3.2-1.66,5.86-3.78,7.32-7v0a2.18,2.18,0,0,0,1.2-2.2,6.7,6.7,0,0,0,2.2-3.37c3.92-10.55,5.79-21.37,4-32.48-1.6-10-7.53-18-19.64-18.05-1.52-.72-2.1-.08-2.25,1.29-.21,1.84-.39,3.7-.71,5.53-3.27,18.49-5.11,37.16-7.82,55.72C561.39,324.8,561.93,325.78,563.88,325.75Z"></path><path d="M637.76,468.58l0,0c-1.13-3.64-4.34-4.78-7.85-5.27q-30.64-4.27-61.32-8.41-28.53-3.87-57.06-7.67l-56.2-7.61q-30.37-4.14-60.76-8.27c-19.68-2.64-39.37-5.2-59-7.86-1.85-.24-2.79.15-2.89,1.9a11.24,11.24,0,0,0-2.8,6.3c-.74,6.16-1.56,12.31-2.37,18.47-1.87,14.24-3.79,28.48-5.6,42.72-1.85,14.52-3.53,29-5.37,43.56-2.23,17.5-4.56,35-6.83,52.5s-4.52,34.83-6.73,52.25c-.36,2.84-.51,5.7,1.65,8.13-.52,3,1.74,3.28,4,3.68,21,3.72,42.09,7.49,63.15,11.17,28,4.9,56.1,9.71,84.14,14.61,13.4,2.34,26.78,4.82,40.18,7.18q40.5,7.14,81,14.2c7.27,1.27,14.47,2.94,21.86,3.49,4.47.33,7.26-1.92,8.16-6,.25-1.13.42-2.28.58-3.42,1.62-11.52,3.21-23,4.86-34.56,2.77-19.43,5.62-38.85,8.38-58.28,3-21,5.91-42,8.9-63.06q4.63-32.57,9.33-65.14C639.4,471.53,639.39,469.82,637.76,468.58Zm-281-7.93c9.75-7,20.65-7.14,32.07-4A33.28,33.28,0,0,1,403,464.27c7.6,7,11.08,15.38,11.31,23.7-.11,13.61-4.67,23.92-16.27,30.28-29.2,16-53.9-3.34-56.08-25.59C340.71,479.49,345.5,468.73,356.76,460.65ZM597.09,602q-4.2,30.32-8.57,60.61c-.66,4.65-1.45,9.29-2.11,13.94a2.83,2.83,0,0,1-1.82,2.49c-.86,0-1.72,0-2.58,0-8.4-.56-16.44-3-24.8-4s-16.71-2.84-25-4.46c-15.22-3-30.57-5.39-45.87-8q-51.56-8.85-103.12-17.67c-7.65-1.31-15.29-2.66-22.94-3.95q-18.57-3.13-37.14-6.22c-.11-6.23,1.28-12.32,2-18.48.52-4.47.78-9,2-13.38.38-.27.8-.49,1.15-.79q23.4-20,46.79-39.93c5.15-4.38,10.38-8.69,15.58-13,2.62-.39,4,1.19,5.4,2.83q11.4,13.81,22.78,27.64c.53,1.41,1.46,1.81,2.86.94,1.19-.75,2.43-1.45,3.55-2.28q46.63-34.57,93.29-69.14c2.83-2.08,5.17-4.71,8.38-6.35a4.12,4.12,0,0,1,4,1.91q25.64,34.43,51.39,68.8c4.47,6,8.78,12.1,13.56,17.87C598.79,594.88,597.58,598.44,597.09,602Z"></path><path d="M847.4,47.85C795.92,44.25,202.55,5.2,202.55,5.2c-6-.4-5.88,5.43-5.88,5.43S94.77,869.8,94.4,875.57s3.31,7.13,3.31,7.13,580.49,129.73,602.57,134.48,57.38,11.55,66.21-43.81,121-798.53,130.66-861C903.9,68.68,888.64,50.73,847.4,47.85Zm-314.09,293q1.86-13.32,3.67-26.65,2.74-20.06,5.5-40.11,2.19-16,4.33-31.93c0-.26.12-.52.16-.78.73-4.92.75-5.09,5.72-4.53,10.49,1.19,21,1.77,31.47,3.45a47.59,47.59,0,0,1,17.74,6.76,9.6,9.6,0,0,0,1.1,1.2,38,38,0,0,1,14.13,22.87,87.21,87.21,0,0,1,1.09,25.6c-.89,9.26-3.86,17.91-7.72,26.32-3.55,7.7-9.42,13.89-16.61,19l-2.26,1.25a1,1,0,0,1-.72,1.28c-4,1.34-8,2.84-12.38,2.67-7.42,1-14.77.09-22.11-.79-6.86-.82-13.7-1.8-20.58-2.46C533.34,343.76,533.06,342.68,533.31,340.85ZM490,331.54q3.76-27.82,7.47-55.66c1.89-14,3.83-28,5.66-41.94.22-1.74,1.11-2,2.68-1.85,7,.71,13.94,1.37,20.9,2.13a21.6,21.6,0,0,1,3.55,1c-.48,1.7-2.19,2.8-2.33,4.77a175.91,175.91,0,0,1-2.61,18.92c-1.86,10.11-2.9,20.36-4.28,30.55-1.26,9.32-2.62,18.62-3.77,27.94-1,7.91-1.73,15.85-2.58,23.77-6,0-11.81-1.26-17.73-1.78-.19,0-.38-.08-.57-.11C489.11,338.19,489.14,338.2,490,331.54ZM407,278.7c1.62-12.75,3.33-25.5,5-38.26.64-4.93,1.29-9.85,1.86-14.78.24-2.12,1.14-2.73,3.57-2.42,6.17.8,12.4,1.24,18.6,1.85.85.09,1.68.35,2.51.52,0,.62,0,1.25-.1,1.86q-1.68,12.63-3.38,25.26c-1.27,9.38-2.59,18.76-3.83,28.15-.9,6.83-1.94,13.65-1.36,20.58.44,5.39,4.18,10.68,8.56,10.51,6.71.12,9.5-1.6,12-7.41s2.9-11.72,3.71-17.69q3.09-23.07,6.12-46.15c.48-3.6,1-7.21,1.38-10.82.14-1.17.41-2.22,2-2,7.59,1,15.27,1.26,22.82,2.53Q484.72,243,483,255.68c-2,14.56-3.74,29.15-5.89,43.69-1.71,11.5-6.05,21.95-16,29.78-11.3,7.9-23.71,7.81-36.09,3.29C412.91,328,407.39,318.6,405.57,307,404.07,297.49,405.8,288.11,407,278.7Zm-72-45.15c3.28-5.46,8.33-9.47,13.51-13.33,4-1.56,7.75-3.7,12.12-4.38,10.81-1.11,20.82.62,29.55,7a27.26,27.26,0,0,1,6.63,6.93,2,2,0,0,1-.1,2.87q-6.12,6.35-12.11,12.8c-1.38,1.5-2.23,1.64-3.66-.15-5.17-6.41-12.43-8.32-19.43-5.36a8.05,8.05,0,0,0-3.15,1.8c-4.94,3.93-7.65,9.1-9.24,14.76-2.54,9-4,18.18-3,27.6a28.34,28.34,0,0,0,5.25,14.44c1.67,2.26,3.77,4,6.92,4.35l1.29.22,1,.31H362c6,0,6.69-.59,7.28-6q.67-6.07,1.6-12.13c.26-1.72-.05-2.69-2.23-2.77s-4.38-.51-6.57-.77c-1.56-.18-2-.87-1.78-2.36.78-5.27,1.48-10.55,2-15.84.19-1.9,1-2.47,2.92-2.27,5.91.63,11.83,1.17,17.73,1.87,3.9.46,7.86.54,11.69,1.46-.38,2.63-.78,5.26-1.12,7.89-1.07,8.34-2.08,16.68-3.2,25-1,7.54-2.11,15.08-2.64,22.67a50,50,0,0,1-31.51,4.92c-16.14-2.59-25.77-12.18-30.05-26C319,276.27,322.49,254.3,335,233.55ZM668.78,470.7l-.36,1.1-1.83,14.4c-.16.53-.32,1.06-.49,1.59-.06.88-.13,1.75-.2,2.63a1.86,1.86,0,0,0-.37,1.63l-.06,1.61c-.79,2.25-.7,4.62-1.12,6.92,0,.53-.05,1.07-.07,1.6-.92,1.87-.47,3.95-1.07,5.86l-.08,2.14c-.77,4.63-1.6,9.24-2.29,13.88-1.29,8.78-2.49,17.56-3.74,26.34q-2.19,15.4-4.4,30.8c-1.21,8.43-2.49,16.84-3.7,25.27-1.48,10.27-2.91,20.54-4.39,30.8-1.41,9.83-2.88,19.65-4.31,29.48-1.46,10.09-2.77,20.2-4.39,30.27-1,6-1,12.21-3,18.08-3,8.9-10.49,13.4-19.7,15.39-4.61,1-9.4-.52-14.08-1.37q-58.3-10.57-116.64-21Q418.74,696.63,355,685.22c-20.1-3.59-40.26-6.92-60.33-10.7-13.18-2.49-19.8-12.73-18.55-23.68,1.91-16.57,4-33.13,6-49.69,2-16.29,4.13-32.58,6.2-48.87,0-.35,0-.71,0-1.06a75,75,0,0,0,1.33-11.66c.12-.56.25-1.11.38-1.67.18-1.24.35-2.48.53-3.73,0-.53.05-1.06.08-1.6.16-.88.32-1.77.49-2.65,1.9-14.77,3.83-29.54,5.69-44.31s3.59-29.38,5.42-44.07c1.14-9.15,2-18.33,3.6-27.42,1.51-8.82,7.21-14.67,16.57-17.31,4.21-.47,8.38.15,12.57.42l.64.39,2.87.14,1.15.38,3.42.16.64.38,2.88.14,1.15.38,3.43.16.62.38,3.41.15.63.38,3.42.16.62.37,3.41.16c.21.13.42.26.64.38l3.41.15.62.37,3.42.18a2.55,2.55,0,0,0,1.8.43l2.25.1,1.21.41,2.3.11a2.52,2.52,0,0,0,1.74.42l2.83.13,1.2.39,2.84.14,1.2.39,2.84.15,1.21.38,2.84.15,1.2.39,6.35.66a3.47,3.47,0,0,0,2.32.44l13.86,1.68a3.43,3.43,0,0,0,2.31.45l1.72.09a2.32,2.32,0,0,0,1.72.39l2.33.14,1.11.35,2.94.18a2.38,2.38,0,0,0,1.71.41l2.32.13a2.34,2.34,0,0,0,1.71.39l2.34.14a2.36,2.36,0,0,0,1.7.4l2.34.12.52.32,4.6.24.64.39,3.4.14.64.38,2.85.16,1.18.37,3.41.16c.22.12.43.25.64.38l3.41.15.63.38,3.42.15.63.38,3.39.16.65.37,3.4.16.64.37,3.4.16.64.38,3.4.15.64.38,3.42.17a2.59,2.59,0,0,0,1.8.43l2.23.09.64.38,3.41.17,1.21.39,2.29.13a2.6,2.6,0,0,0,1.75.41l2.29.11.57.34,4,.2.63.38,15.53,1.77,1.22.39,6.34.66a2.39,2.39,0,0,0,1.73.4l11.49,1.2.65.4,3.39.13.66.41,3.38.12.65.4,19,2.26.6.35,8,.72.64.4,10.94,1.21,1.17.37q15.22,2.06,30.45,4.09c7.48,1,15,2,22.46,3,11.77,1.47,21,11.21,21.12,22.15C669.57,464.21,668.78,467.42,668.78,470.7Zm28.55-215.62c-.81,5.45-1.64,10.89-2.33,16.35-.23,1.76-.88,2.08-2.8,1.85-8.66-1.06-17.35-1.9-26-2.85-1.77-.2-2.43.44-2.46,2-.1,5.33-1.25,10.57-1.91,15.85-.4,3.26-.39,3.42,3.14,3.8,6.86.75,13.73,1.47,20.6,2.2,3.48.37,3.62.58,3.14,3.83-.67,4.57-1.29,9.14-1.9,13.72-.44,3.27-.73,3.41-4.13,3-7-.86-14.1-1.58-21.15-2.41-2.47-.29-3.53.28-3.75,2.88-.49,5.83-1.35,11.64-2.37,17.41-.4,2.25.5,2.86,2.57,3.09,8.29.9,16.58,1.87,24.88,2.75,4.33.46,4.45.54,3.87,4.46-.76,5.18-1.56,10.36-2.23,15.55-.28,2.22-1.1,2.88-3.72,2.55-17.32-2.15-34.67-4.11-52-6.12-3.55-.41-3.67-.49-3.21-3.72q5.47-38.9,11-77.79c1.2-8.53,2.42-17.06,3.49-25.6.23-1.82,1.09-2.29,3.45-1.95,8.72.86,18.07,1.77,27.43,2.72q11.6,1.17,23.18,2.43C697.82,251.53,697.84,251.66,697.33,255.08Z"></path><path d="M590.91,344.57a1,1,0,0,0,.72-1.28,106.91,106.91,0,0,1-13.1,3.95C582.93,347.41,586.9,345.91,590.91,344.57Z" fill="#a6d5ff"></path></svg>`
export const guides: GuideListGuide[] = globalsElement?.dataset?.guides
  ? JSON.parse(globalsElement.dataset.guides)
  : null
export const proEdition: boolean = globalsElement?.dataset?.proEdition
  ? globalsElement.dataset.proEdition === 'true'
  : false
export async function showGuideSlideout({
  docs = false,
  elementId = -1,
  groupHandle = '',
  slug = '',
}: ShowGuideSlideoutOptions) {
  if (proEdition || docs) {
    await window.Craft?.postActionRequest(
      'guide/slideout',
      { docs, elementId: elementId ?? null, groupHandle: groupHandle ?? null, slug },
      (response: { data: string }, textStatus: string) => {
        if (textStatus === 'success') {
          const slideout = new window.Craft.Slideout(response.data)
          slideout.open()
          slideout.on('close', () => {
            slideout.destroy()
          })
        }
      }
    )
  }
}
export const settings: PluginSettings = globalsElement?.dataset?.settings
  ? JSON.parse(globalsElement.dataset.settings)
  : null
export const userOperations: PluginUserOperations = globalsElement?.dataset?.userOperations
  ? JSON.parse(globalsElement.dataset.userOperations)
  : null

// Set text to kebab-case
export function kebab(text: string) {
  /* eslint-disable */
  return text
    .toString()
    .toLowerCase()
    .replace(/\s+/g, '-') // Replace spaces with -
    .replace(/[^\w\-]+/g, '') // Remove all non-word chars
    .replace(/\-\-+/g, '-') // Replace multiple - with single -
    .replace(/^-+/, '') // Trim - from start of text
    .replace(/-+$/, '') // Trim - from end of text
  /* eslint-enable */
}

/*
 * Add Guide Buttons to field headers on load and after specific UI events.
 */
if (proEdition) {
  window.Garnish.on(window.Craft.ElementEditor, 'update', () => {
    addFieldHeaderGuideButtons()
  })
  window.Garnish.on(window.Craft.ElementEditorSlideout, 'load', () => {
    addFieldHeaderGuideButtons()
  })
  window.Garnish.on(window.Craft.Preview, 'open', () => {
    addFieldHeaderGuideButtons()
  })

  addFieldHeaderGuideButtons()
}
